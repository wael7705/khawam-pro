# نظام مالي محاسبي متطور - PRD

## نظرة عامة
نظام مالي محاسبي متطور لإدارة الأسعار والطلبات مع دعم كامل للطباعة والخدمات.

## المبادئ الأساسية

### 1. نظام حساب الأسعار
- **السعر الأساسي**: يمثل سعر الوحدة الواحدة (صفحة، قطعة، متر مربع)
- **طباعة وجهين**: يتم حسابها تلقائياً = السعر الأساسي × 2
- **لا حاجة لقواعد منفصلة**: قاعدة واحدة لكل نوع، والوجهين يحسب تلقائياً

### 2. أنواع الحساب
- **piece**: حساب بالقطعة
- **area**: حساب بالمساحة (متر مربع)
- **page**: حساب بالصفحة (للطباعة)

### 3. القواعد المالية

#### قواعد الطباعة (Page)
1. **A4 - أبيض وأسود**: 50 ل.س (صفحة وجه واحد)
2. **A4 - ملون عادي**: 100 ل.س (صفحة وجه واحد)
3. **A4 - ملون دقة عالية**: 150 ل.س (صفحة وجه واحد)
4. **Booklet (A5) - أبيض وأسود**: 40 ل.س (صفحة وجه واحد)
5. **Booklet (A5) - ملون عادي**: 80 ل.س (صفحة وجه واحد)
6. **Booklet (A5) - ملون دقة عالية**: 120 ل.س (صفحة وجه واحد)

#### مثال على الحساب:
- صفحة A4 أبيض وأسود وجه واحد: 50 ل.س
- صفحة A4 أبيض وأسود وجهين: 50 × 2 = 100 ل.س
- 10 صفحات A4 أبيض وأسود وجه واحد: 10 × 50 = 500 ل.س
- 10 صفحات A4 أبيض وأسود وجهين: 10 × 50 × 2 = 1000 ل.س

### 4. خوارزمية المطابقة
النظام يبحث عن أفضل قاعدة سعر تطابق المواصفات:
- **نوع اللون** (color): +2 نقاط
- **عدد الوجوه** (sides): +2 نقاط (لكن لا يحتاج قاعدة منفصلة)
- **قياس الورق** (paper_size): +1 نقطة
- **نوع الوحدة** (unit): +1 نقطة
- **جودة الطباعة** (print_quality): +1 نقطة

### 5. معالجة الأخطاء
- إذا لم توجد قاعدة سعر مطابقة: السعر = 0
- لا يمكن إنشاء طلب بسعر = 0
- رسائل خطأ واضحة للمستخدم

## البنية التقنية

### قاعدة البيانات
- **pricing_rules**: جدول القواعد المالية
  - `calculation_type`: نوع الحساب (piece/area/page)
  - `base_price`: السعر الأساسي
  - `specifications`: مواصفات القاعدة (JSON)
  - `unit`: نوع الوحدة
  - `is_active`: حالة النشاط

### API Endpoints
- `POST /api/pricing/calculate-price`: حساب السعر بناءً على المواصفات
- `GET /api/pricing/pricing-rules`: جلب جميع القواعد
- `POST /api/pricing/pricing-rules`: إنشاء قاعدة جديدة
- `PUT /api/pricing/pricing-rules/{id}`: تحديث قاعدة
- `DELETE /api/pricing/pricing-rules/{id}`: حذف قاعدة

### منطق الحساب
```python
def calculate_price(calculation_type, quantity, base_price, specifications):
    price = base_price
    
    # تطبيق معاملات إضافية (لون، جودة، إلخ)
    if specifications.get("color") == "color":
        price *= color_multiplier
    
    # حساب السعر النهائي
    if calculation_type == "page":
        total = price * quantity
        # إذا كان وجهين، ضرب × 2
        if specifications.get("sides") == "double":
            total = total * 2
    elif calculation_type == "area":
        total = price * quantity  # quantity = المساحة
    else:  # piece
        total = price * quantity
    
    return total
```

## التدفق

### 1. إنشاء طلب
```
المستخدم يملأ النموذج
    ↓
تحديد نوع الحساب (piece/area/page)
    ↓
بناء المواصفات (color, sides, paper_size, etc.)
    ↓
استدعاء API: /api/pricing/calculate-price
    ↓
البحث عن أفضل قاعدة مطابقة
    ↓
حساب السعر (مع تطبيق × 2 للوجهين)
    ↓
عرض السعر للمستخدم
    ↓
إنشاء الطلب
```

### 2. التحقق من السعر
```
إذا السعر = 0:
    ↓
عرض رسالة خطأ
    ↓
منع إنشاء الطلب
    ↓
طلب إضافة قاعدة سعر مناسبة
```

## الأمان والتحقق
- السعر يجب أن يأتي من القواعد المالية فقط
- لا يوجد حساب يدوي (fallback)
- التحقق من وجود قاعدة قبل إنشاء الطلب
- رسائل خطأ واضحة للمستخدم

## التطوير المستقبلي
- إضافة نظام خصومات
- إضافة نظام كوبونات
- إضافة تقارير مالية
- إضافة نظام إشعارات للأسعار الجديدة

